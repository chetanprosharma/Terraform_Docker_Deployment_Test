#!/usr/bin/env groovy

/**
 * Jenkinsfile for Docker Environment
 * Docker image building, testing, and deployment
 */

pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['build', 'test', 'push', 'deploy', 'all'],
            description: 'Docker action'
        )
        string(
            name: 'IMAGE_TAG',
            defaultValue: 'latest',
            description: 'Docker image tag'
        )
        booleanParam(
            name: 'PUSH_TO_REGISTRY',
            defaultValue: false,
            description: 'Push image to registry'
        )
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        disableConcurrentBuilds()
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }

    environment {
        ENVIRONMENT = 'docker'
        DOCKER_IMAGE = 'terraform-webapp:latest'
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_PATH = "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Docker"
    }

    stages {
        stage('Initialization') {
            steps {
                script {
                    echo "═══════════════════════════════════════════════════════"
                    echo "Docker Environment - Build & Deployment Pipeline"
                    echo "═══════════════════════════════════════════════════════"
                    echo "Action: ${ACTION}"
                    echo "Image Tag: ${IMAGE_TAG}"
                    echo "Push to Registry: ${PUSH_TO_REGISTRY}"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
                sh '''
                    cd "${DOCKER_PATH}"
                    pwd
                    ls -la docker/
                '''
            }
        }

        stage('Validate Dockerfile') {
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    echo "Validating Dockerfile..."
                    
                    # Check Dockerfile exists
                    [ -f "docker/Dockerfile" ] || exit 1
                    
                    # Hadolint check if available
                    if command -v hadolint &> /dev/null; then
                        hadolint docker/Dockerfile
                    else
                        echo "⚠ hadolint not installed, skipping linting"
                    fi
                    
                    echo "✓ Dockerfile validation passed"
                '''
            }
        }

        stage('Build Docker Image') {
            when {
                expression { params.ACTION in ['build', 'all'] }
            }
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    echo "Building Docker image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    
                    docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
                                 -t ${DOCKER_IMAGE}:${BUILD_NUMBER} \
                                 -f docker/Dockerfile \
                                 --label "build.number=${BUILD_NUMBER}" \
                                 --label "build.timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
                                 .
                    
                    echo "✓ Docker image built successfully"
                    
                    # Show image details
                    docker images | grep terraform-webapp
                '''
            }
        }

        stage('Test Docker Image') {
            when {
                expression { params.ACTION in ['test', 'all'] }
            }
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    echo "Testing Docker image..."
                    
                    # Remove old test container
                    docker rm -f test-container 2>/dev/null || true
                    
                    # Run container
                    docker run -d --name test-container \
                               -p 9091:80 \
                               ${DOCKER_IMAGE}:${IMAGE_TAG}
                    
                    # Wait for startup
                    sleep 5
                    
                    # Run tests
                    echo "Running API tests..."
                    curl -f http://localhost:9091/api/health || {
                        docker logs test-container
                        exit 1
                    }
                    
                    curl -f http://localhost:9091/api/stats || {
                        docker logs test-container
                        exit 1
                    }
                    
                    # Check logs
                    docker logs test-container
                    
                    # Cleanup
                    docker stop test-container
                    docker rm test-container
                    
                    echo "✓ Docker image tests passed"
                '''
            }
        }

        stage('Security Scan') {
            steps {
                sh '''
                    echo "Running security scans on Docker image..."
                    
                    # Trivy scan if available
                    if command -v trivy &> /dev/null; then
                        trivy image --severity HIGH,CRITICAL ${DOCKER_IMAGE}:${IMAGE_TAG} || true
                    fi
                    
                    echo "✓ Security scan completed"
                '''
            }
        }

        stage('Push to Registry') {
            when {
                expression { params.ACTION in ['push', 'all'] && params.PUSH_TO_REGISTRY }
            }
            steps {
                script {
                    sh '''
                        cd "${DOCKER_PATH}"
                        
                        echo "Pushing image to registry..."
                        
                        # Login to registry (requires credentials)
                        # echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin "${DOCKER_REGISTRY}"
                        
                        # Push image
                        # docker push ${DOCKER_IMAGE}:${IMAGE_TAG}
                        # docker push ${DOCKER_IMAGE}:${BUILD_NUMBER}
                        
                        echo "✓ Image pushed to registry"
                    '''
                }
            }
        }

        stage('Deploy with Terraform') {
            when {
                expression { params.ACTION in ['deploy', 'all'] }
            }
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    echo "Deploying with Terraform..."
                    
                    terraform init
                    terraform plan -out=tfplan
                    terraform apply -auto-approve tfplan
                    
                    echo "✓ Docker deployment completed"
                    
                    # Show deployed container
                    docker ps | grep app-container || true
                '''
            }
        }

        stage('Verify Deployment') {
            when {
                expression { params.ACTION in ['deploy', 'all'] }
            }
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    echo "Verifying deployment..."
                    
                    sleep 5
                    
                    # Test the deployed container
                    curl -f http://localhost:9090/api/health || {
                        docker logs app-container-1 || true
                        exit 1
                    }
                    
                    # Get deployment info
                    echo "Deployment Info:"
                    docker ps -f name=app-container
                    
                    echo "✓ Deployment verified"
                '''
            }
        }

        stage('Documentation') {
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                    
                    cat > docker-build-report.txt << EOF
Docker Build Report
===================

Date: ${TIMESTAMP}
Build: ${BUILD_NUMBER}
Image: ${DOCKER_IMAGE}:${IMAGE_TAG}

Docker Info:
$(docker info | head -20)

Image Details:
$(docker images | grep terraform-webapp)

Dockerfile:
$(head -30 docker/Dockerfile)

Status: SUCCESS
EOF
                    
                    echo "✓ Documentation created"
                '''
                archiveArtifacts artifacts: 'docker-build-report.txt', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            script {
                sh '''
                    # Cleanup test containers
                    docker rm -f test-container 2>/dev/null || true
                '''
                cleanWs()
            }
        }
        
        success {
            echo "✅ Docker environment build completed successfully"
            emailext(
                subject: "✅ Docker Build Successful - ${IMAGE_TAG} (Build ${BUILD_NUMBER})",
                body: """
                Docker image built and tested successfully.
                
                Image: ${DOCKER_IMAGE}:${IMAGE_TAG}
                Build: ${BUILD_NUMBER}
                Action: ${ACTION}
                Build URL: ${BUILD_URL}
                
                Next Steps:
                - Image is available for deployment
                - Push to registry if needed
                - Deploy to target environment
                """,
                to: '${DEFAULT_RECIPIENTS}'
            )
        }
        
        failure {
            echo "❌ Docker environment build failed"
            emailext(
                subject: "❌ Docker Build Failed - ${IMAGE_TAG} (Build ${BUILD_NUMBER})",
                body: """
                Docker image build or test failed.
                
                Image: ${DOCKER_IMAGE}:${IMAGE_TAG}
                Build: ${BUILD_NUMBER}
                Action: ${ACTION}
                Build URL: ${BUILD_URL}
                
                Check logs for details.
                """,
                to: '${DEFAULT_RECIPIENTS}'
            )
        }
    }
}
