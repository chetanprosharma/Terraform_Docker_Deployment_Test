#!/usr/bin/env groovy

/**
 * Jenkinsfile for Docker Environment
 * Docker image building, testing, and deployment
 */

pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['build', 'test', 'push', 'deploy', 'all'],
            description: 'Docker action'
        )
        string(
            name: 'IMAGE_TAG',
            defaultValue: 'latest',
            description: 'Docker image tag'
        )
        booleanParam(
            name: 'PUSH_TO_REGISTRY',
            defaultValue: false,
            description: 'Push image to registry'
        )
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        disableConcurrentBuilds()
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }

    environment {
        ENVIRONMENT = 'docker'
        DOCKER_IMAGE = 'terraform-webapp:latest'
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_PATH = "${WORKSPACE}/Terraform/EC2\ Provisioning/Environments/Docker"
    }

    stages {
        stage('Initialization') {
            steps {
                script {
                    echo "═══════════════════════════════════════════════════════"
                    echo "Docker Environment - Build & Deployment Pipeline"
                    echo "═══════════════════════════════════════════════════════"
                    echo "Action: ${ACTION}"
                    echo "Image Tag: ${IMAGE_TAG}"
                    echo "Push to Registry: ${PUSH_TO_REGISTRY}"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
                sh '''
                    cd "${DOCKER_PATH}"
                    pwd
                    ls -la docker/
                '''
            }
        }

        stage('Build Docker Image') {
            when {
                expression { params.ACTION in ['build', 'all'] }
            }
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    echo "Building Docker image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    
                    docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
                                 -t ${DOCKER_IMAGE}:${BUILD_NUMBER} \
                                 -f docker/Dockerfile \
                                 --label "build.number=${BUILD_NUMBER}" \
                                 --label "build.timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
                                 .
                    
                    echo "✓ Docker image built successfully"
                    
                    # Show image details
                    docker images | grep terraform-webapp
                '''
            }
        }

        stage('Security Scan') {
            steps {
                sh '''
                    echo "Running security scans on Docker image..."
                    
                    # Trivy scan if available
                    if command -v trivy &> /dev/null; then
                        trivy image --severity HIGH,CRITICAL ${DOCKER_IMAGE}:${IMAGE_TAG} || true
                    fi
                    
                    echo "✓ Security scan completed"
                '''
            }
        }

        stage('Deploy with Terraform') {
            when {
                expression { params.ACTION in ['deploy', 'all'] }
            }
            steps {
                sh '''
                    cd "${DOCKER_PATH}"
                    
                    echo "Deploying with Terraform..."
                    
                    terraform init
                    terraform plan -out=tfplan
                    terraform apply -auto-approve tfplan
                    
                    echo "✓ Docker deployment completed"
                    
                    # Show deployed container
                    docker ps | grep app-container || true
                '''
            }
        }
    }

    post {
        always {
            script {
                sh '''
                    # Cleanup test containers
                    docker rm -f test-container 2>/dev/null || true
                '''
                cleanWs()
            }
        }
        
        success {
            echo "✅ Docker environment build completed successfully"
            emailext(
                subject: "✅ Docker Build Successful - ${IMAGE_TAG} (Build ${BUILD_NUMBER})",
                body: """
                Docker image built and tested successfully.
                
                Image: ${DOCKER_IMAGE}:${IMAGE_TAG}
                Build: ${BUILD_NUMBER}
                Action: ${ACTION}
                Build URL: ${BUILD_URL}
                
                Next Steps:
                - Image is available for deployment
                - Push to registry if needed
                - Deploy to target environment
                """,
                to: '${DEFAULT_RECIPIENTS}'
            )
        }
        
        failure {
            echo "❌ Docker environment build failed"
            emailext(
                subject: "❌ Docker Build Failed - ${IMAGE_TAG} (Build ${BUILD_NUMBER})",
                body: """
                Docker image build or test failed.
                
                Image: ${DOCKER_IMAGE}:${IMAGE_TAG}
                Build: ${BUILD_NUMBER}
                Action: ${ACTION}
                Build URL: ${BUILD_URL}
                
                Check logs for details.
                """,
                to: '${DEFAULT_RECIPIENTS}'
            )
        }
    }
}
