#!/usr/bin/env groovy

/**
 * Jenkinsfile for Dev Environment
 * Automated provisioning and deployment for development
 */

pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy', 'validate'],
            description: 'Action to perform'
        )
        booleanParam(
            name: 'AUTO_APPROVE',
            defaultValue: true,
            description: 'Auto-approve Terraform changes'
        )
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        disableConcurrentBuilds()
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
    }

    environment {
        ENVIRONMENT = 'dev'
        TF_VAR_environment = 'dev'
        AWS_REGION = 'us-east-1'
    }

    stages {
        stage('Initialization') {
            steps {
                script {
                    echo "═══════════════════════════════════════════════════════"
                    echo "DEV Environment - Terraform Provisioning"
                    echo "═══════════════════════════════════════════════════════"
                    echo "Action: ${ACTION}"
                    echo "Auto-Approve: ${AUTO_APPROVE}"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Dev"
                    pwd
                    ls -la
                '''
            }
        }

        stage('Terraform Validate') {
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Dev"
                    terraform init -backend=false
                    terraform validate
                    echo "✓ Validation passed"
                '''
            }
        }

        stage('Terraform Format Check') {
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Dev"
                    terraform fmt -check -recursive || terraform fmt -recursive
                '''
            }
        }

        stage('Terraform Plan') {
            when {
                expression { params.ACTION in ['plan', 'apply'] }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Dev"
                    terraform init
                    terraform plan -out=tfplan
                    terraform show tfplan > tfplan-dev.txt
                '''
                archiveArtifacts artifacts: 'tfplan-dev.txt', allowEmptyArchive: true
            }
        }

        stage('Terraform Apply') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Dev"
                    
                    if [ "${AUTO_APPROVE}" = "true" ]; then
                        terraform apply -auto-approve tfplan
                    else
                        terraform apply tfplan
                    fi
                    
                    terraform output -json > dev-outputs.json
                '''
                archiveArtifacts artifacts: 'dev-outputs.json', allowEmptyArchive: true
            }
        }

        stage('Terraform Destroy') {
            when {
                expression { params.ACTION == 'destroy' }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Dev"
                    terraform init
                    terraform destroy -auto-approve
                    echo "✓ Dev infrastructure destroyed"
                '''
            }
        }

        stage('Post-Deployment Validation') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Dev"
                    echo "Running health checks..."
                    terraform output
                    echo "✓ Health checks completed"
                '''
            }
        }

        stage('Trigger Docker Build') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    echo "Triggering Docker build pipeline..."
                    build job: 'Docker-Build-Dev', wait: false, parameters: [
                        string(name: 'ENVIRONMENT', value: 'dev')
                    ]
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        
        success {
            echo "✅ Dev environment provisioning completed successfully"
            emailext(
                subject: "✅ Dev Infrastructure Provisioned - Build ${BUILD_NUMBER}",
                body: "Dev environment provisioning completed successfully. Build: ${BUILD_URL}",
                to: '${DEFAULT_RECIPIENTS}'
            )
        }
        
        failure {
            echo "❌ Dev environment provisioning failed"
            emailext(
                subject: "❌ Dev Infrastructure Provisioning Failed - Build ${BUILD_NUMBER}",
                body: "Dev environment provisioning failed. Check logs: ${BUILD_URL}",
                to: '${DEFAULT_RECIPIENTS}'
            )
        }
    }
}
