#!/usr/bin/env groovy

/**
 * Jenkinsfile for Production Environment
 * Strict controls, approval gates, and safety measures
 */

pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'validate'],
            description: 'Action to perform (destroy not allowed)'
        )
        booleanParam(
            name: 'AUTO_APPROVE',
            defaultValue: false,
            description: 'Auto-approve (requires manual approval for PROD)'
        )
        string(
            name: 'APPROVERS',
            defaultValue: 'terraform-prod-approvers',
            description: 'Jenkins group authorized to approve'
        )
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        disableConcurrentBuilds()
        timestamps()
        timeout(time: 2, unit: 'HOURS')
        skipDefaultCheckout()
    }

    environment {
        ENVIRONMENT = 'prod'
        TF_VAR_environment = 'prod'
        AWS_REGION = 'us-east-1'
        BACKUP_DIR = '/var/backups/terraform'
    }

    stages {
        stage('Initialization') {
            steps {
                script {
                    echo "╔════════════════════════════════════════════════════════╗"
                    echo "║         PRODUCTION Environment - CRITICAL PATH         ║"
                    echo "╚════════════════════════════════════════════════════════╝"
                    echo "Action: ${ACTION}"
                    echo "Timestamp: ${new Date()}"
                    echo "Build: ${BUILD_NUMBER}"
                    
                    // Validate caller
                    def causeDescription = currentBuild.description ?: 'Unknown'
                    echo "Initiated by: ${causeDescription}"
                }
            }
        }

        stage('Pre-Flight Checks') {
            steps {
                script {
                    echo "Running pre-flight checks..."
                    sh '''
                        # Check terraform installed
                        terraform version
                        
                        # Check AWS credentials
                        aws sts get-caller-identity
                        
                        echo "✓ Pre-flight checks passed"
                    '''
                }
            }
        }

        stage('Checkout Code') {
            steps {
                checkout scm
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    pwd
                    ls -la
                '''
            }
        }

        stage('Backup Current State') {
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    BACKUP_DIR="/tmp/terraform-backups"
                    mkdir -p "${BACKUP_DIR}"
                    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                    
                    # Backup terraform state
                    if [ -f "terraform.tfstate" ]; then
                        cp terraform.tfstate "${BACKUP_DIR}/terraform.tfstate.${TIMESTAMP}.bak"
                        echo "✓ State backup created: terraform.tfstate.${TIMESTAMP}.bak"
                    fi
                    
                    # Backup lock file
                    if [ -f ".terraform.lock.hcl" ]; then
                        cp .terraform.lock.hcl "${BACKUP_DIR}/.terraform.lock.${TIMESTAMP}.bak"
                    fi
                '''
            }
        }

        stage('Validate Configuration') {
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    echo "Validating Terraform configuration..."
                    terraform init -backend=false
                    terraform validate
                    
                    echo "Checking code quality..."
                    terraform fmt -check -recursive || terraform fmt -recursive
                    
                    echo "✓ Configuration validation passed"
                '''
            }
        }

        stage('Security Scan') {
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    echo "Running security scans..."
                    
                    # Checkov scan (if installed)
                    if command -v checkov &> /dev/null; then
                        checkov -d . --framework terraform --output cli || true
                    fi
                    
                    # TFSec scan (if installed)
                    if command -v tfsec &> /dev/null; then
                        tfsec . --format json > tfsec-report.json || true
                    fi
                    
                    echo "✓ Security scans completed"
                '''
                archiveArtifacts artifacts: 'tfsec-report.json', allowEmptyArchive: true
            }
        }

        stage('Plan Infrastructure') {
            when {
                expression { params.ACTION in ['plan', 'apply'] }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    echo "Planning infrastructure changes..."
                    terraform init
                    terraform plan -out=tfplan -lock=true
                    terraform show tfplan > tfplan-prod.txt
                    
                    echo "✓ Plan completed successfully"
                    echo ""
                    echo "PLAN SUMMARY:"
                    grep -E "Plan:|No changes|will be|must be|will be destroyed" tfplan-prod.txt || true
                '''
                archiveArtifacts artifacts: 'tfplan-prod.txt', allowEmptyArchive: true
            }
        }

        stage('Manual Approval') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    try {
                        timeout(time: 24, unit: 'HOURS') {
                            input(
                                id: 'ProductionApproval',
                                message: '''
                                ╔════════════════════════════════════════════════════════╗
                                ║  ⚠️  PRODUCTION DEPLOYMENT APPROVAL REQUIRED ⚠️        ║
                                ╚════════════════════════════════════════════════════════╝
                                
                                Review the Terraform plan above carefully.
                                
                                By approving, you authorize changes to PRODUCTION infrastructure.
                                
                                Questions to consider:
                                • Has this been tested in the test environment?
                                • Have all team members reviewed the changes?
                                • Is this a scheduled maintenance window?
                                • Do you have a rollback plan?
                                
                                APPROVE TO CONTINUE WITH PRODUCTION DEPLOYMENT
                                ''',
                                ok: 'APPROVE PRODUCTION DEPLOYMENT',
                                submitter: 'terraform-prod-approvers'
                            )
                            echo "✓ Production deployment APPROVED"
                        }
                    } catch (err) {
                        error("Production deployment REJECTED or timeout")
                    }
                }
            }
        }

        stage('Apply Infrastructure') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    echo "Applying infrastructure changes to PRODUCTION..."
                    echo "Time: $(date)"
                    
                    terraform apply -lock=true tfplan
                    
                    echo "✓ Infrastructure applied successfully"
                    
                    # Capture outputs
                    terraform output -json > prod-outputs.json
                    terraform show -json > prod-state.json
                    
                    echo "Time: $(date)"
                '''
                archiveArtifacts artifacts: 'prod-outputs.json,prod-state.json', allowEmptyArchive: true
            }
        }

        stage('Validate Deployment') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    echo "Validating production deployment..."
                    
                    # Show outputs
                    echo "Infrastructure Outputs:"
                    terraform output
                    
                    # Run smoke tests
                    if [ -f "../../tests/smoke-tests.sh" ]; then
                        bash "../../tests/smoke-tests.sh" prod
                    fi
                    
                    # Run health checks
                    if [ -f "../../tests/health-checks.sh" ]; then
                        bash "../../tests/health-checks.sh" prod
                    fi
                    
                    echo "✓ Deployment validation completed"
                '''
            }
        }

        stage('Post-Deployment Documentation') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                    
                    cat > deployment-summary.md << EOF
# Production Deployment Summary

**Date**: ${TIMESTAMP}
**Build Number**: ${BUILD_NUMBER}
**Jenkins Job**: ${JOB_NAME}
**Status**: SUCCESS

## Infrastructure State
$(terraform show -json | jq '.' | head -50)

## Outputs
$(terraform output -json | jq '.' )

## Approvers
- Approved by: ${APPROVER:-System}
- Approval Time: ${TIMESTAMP}

## Rollback Information
State backup: terraform.tfstate.${TIMESTAMP}.bak
Location: /tmp/terraform-backups/

## Next Steps
1. Monitor production metrics
2. Verify all services are healthy
3. Document any manual changes
4. Schedule post-deployment review
EOF
                    
                    echo "✓ Documentation created"
                '''
                archiveArtifacts artifacts: 'deployment-summary.md', allowEmptyArchive: true
            }
        }

        stage('Validate Only') {
            when {
                expression { params.ACTION == 'validate' }
            }
            steps {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod"
                    
                    terraform init -backend=false
                    terraform validate
                    terraform fmt -check -recursive
                    
                    echo "✓ All validations passed"
                '''
            }
        }
    }

    post {
        always {
            script {
                sh '''
                    cd "${WORKSPACE}/Terraform/EC2 Provisioning/Environments/Prod" || true
                    
                    # Archive all logs
                    find . -name "*.log" -o -name "*.txt" -o -name "*.json" | head -50 | xargs tar -czf terraform-logs.tar.gz || true
                '''
                archiveArtifacts artifacts: 'terraform-logs.tar.gz', allowEmptyArchive: true
            }
        }
        
        success {
            script {
                echo "╔════════════════════════════════════════════════════════╗"
                echo "║  ✅ PRODUCTION DEPLOYMENT COMPLETED SUCCESSFULLY ✅    ║"
                echo "╚════════════════════════════════════════════════════════╝"
                
                emailext(
                    subject: "✅ PRODUCTION Deployment Successful - Build ${BUILD_NUMBER}",
                    body: """
                    PRODUCTION DEPLOYMENT COMPLETED SUCCESSFULLY
                    
                    Build: ${BUILD_NUMBER}
                    Job: ${JOB_NAME}
                    Duration: ${currentBuild.durationString}
                    Build URL: ${BUILD_URL}
                    
                    Action: ${ACTION}
                    Timestamp: ${new Date()}
                    
                    Archive: ${BUILD_URL}artifact/
                    
                    NEXT STEPS:
                    1. Monitor production metrics
                    2. Verify application health
                    3. Document changes in JIRA/ticket system
                    4. Schedule post-deployment review
                    5. Notify stakeholders
                    """,
                    to: '${DEFAULT_RECIPIENTS}',
                    mimeType: 'text/plain',
                    recipientProviders: [developers(), requestor()]
                )
            }
        }
        
        failure {
            script {
                echo "╔════════════════════════════════════════════════════════╗"
                echo "║  ❌ PRODUCTION DEPLOYMENT FAILED - IMMEDIATE ACTION    ║"
                echo "╚════════════════════════════════════════════════════════╝"
                
                emailext(
                    subject: "❌ CRITICAL: PRODUCTION Deployment FAILED - Build ${BUILD_NUMBER}",
                    body: """
                    PRODUCTION DEPLOYMENT FAILED
                    
                    Build: ${BUILD_NUMBER}
                    Job: ${JOB_NAME}
                    Build URL: ${BUILD_URL}
                    
                    Action: ${ACTION}
                    Timestamp: ${new Date()}
                    
                    IMMEDIATE ACTION REQUIRED:
                    1. Check console logs: ${BUILD_URL}console
                    2. Review terraform plan for errors
                    3. Check AWS console for partial deployments
                    4. Prepare rollback if necessary
                    5. Notify infrastructure team immediately
                    
                    Backups available in /tmp/terraform-backups/
                    
                    ERROR DETAILS:
                    See full logs at: ${BUILD_URL}artifact/
                    """,
                    to: '${DEFAULT_RECIPIENTS}',
                    mimeType: 'text/plain',
                    recipientProviders: [developers(), requestor()]
                )
            }
        }
        
        cleanup {
            cleanWs()
        }
    }
}
